<feed xmlns="http://www.w3.org/2005/Atom"><title></title>
<link href="http://hamasyou.com/atom.xml" rel="self">
<link href="http://hamasyou.com/">
<updated>2014-02-13T17:23:08+09:00</updated><id>http://hamasyou.com/</id><author><name></name></author><generator uri="http://octopress.org/">Octopress</generator><entry><title type="html"></title>
<link href="http://hamasyou.com/blog/2014/02/13/ruby-nokogiri/">
<updated>2014-02-13T16:19:09+09:00</updated><id>http://hamasyou.com/blog/2014/02/13/ruby-nokogiri</id><content type="html">Ruby の HTML パーサに <strong class="text-danger">Nokogiri</strong> があります。基本的な使い方は

<ul>
<li><a href="https://github.com/sparklemotion/nokogiri" rel="external nofollow" title="Nokogiri-GitHub">Nokogiri-GitHub</a></li>
<li><a href="http://www.absolute-keitarou.net/blog/?p=634" rel="external nofollow" title="RubyのNokogiriでギコギコスクレイピングだ">RubyのNokogiriでギコギコスクレイピングだ</a></li>
<li><a href="http://qiita.com/w650/items/e663fa2430145c456c4d" rel="external nofollow" title="Nokogiriでスクレイピング">Nokogiriでスクレイピング</a></li>
</ul>
<p>とかを参考にしてもらえばいいんですが、パースした要素の特定の属性を置き換えたいとか追加で属性を追加したい時のメモです。</p>

<!-- more -->


<p>使い方は</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr>
<td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td>
<td class="code"><pre><code class=""><span class="line">gem install 'nokogiri'</span></code></pre></td>
</tr></table></div></figure></notextile></div>




<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr>
<td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td>
<td class="code"><pre><code class="ruby"><span class="line"><span class="nb">require</span> <span class="s1">'nokogiri'</span>
</span><span class="line">
</span><span class="line"><span class="n">doc</span> <span class="o">=</span> <span class="ss">Nokogiri</span><span class="p">:</span><span class="ss">:HTML</span><span class="p">(</span><span class="n">html_text</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c1"># 外部リンクに rel="external nofollow" と title 属性を付ける</span>
</span><span class="line"><span class="n">doc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'a[href^="http://"]'</span><span class="p">,</span> <span class="s1">'a[href^="https://"]'</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class="line">  <span class="n">link</span><span class="o">[</span><span class="s1">'rel'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">link</span><span class="o">[</span><span class="s1">'rel'</span><span class="o">]</span><span class="si">}</span><span class="s2"> external nofollow"</span><span class="o">.</span><span class="n">strip</span>
</span><span class="line">  <span class="n">link</span><span class="o">[</span><span class="s1">'title'</span><span class="o">]</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">text</span> <span class="k">unless</span> <span class="n">link</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s1">'title'</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line"><span class="n">html_text</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">'body'</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">inner_html</span>
</span></code></pre></td>
</tr></table></div></figure></notextile></div>


<p>Nokogiri に渡す HTML 文字列は <code>&lt;html&gt;</code> から始まる必要はなく、部分的な HTML 文字列でも OK です。</p>

<p>部分 HTML を置き換えた場合は、取り出しは <code>doc.css('body')[0].inner_html</code> になります。<code>doc.to_html</code> だと <code>&lt;!DOCTYPE html&gt;&lt;html&gt;</code> から始まる文字列になってしまうので注意。</p>

<h3>文字コードを指定する</h3>

<p>Nokogiri は日本語に対応していますが、デフォルトで <em>UTF-8</em> の文字エンコーディングになっているようです。なので Shift_JIS や EUC-JP の HTML を与えるとうまくパースできません。</p>

<p>そんな時は、次のようなコードで UTF-8 に変換してやれば OK です。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr>
<td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td>
<td class="code"><pre><code class="ruby"><span class="line"><span class="n">doc</span> <span class="o">=</span> <span class="ss">Nokogiri</span><span class="p">:</span><span class="ss">:HTML</span><span class="p">(</span><span class="n">html_text</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">)</span>
</span></code></pre></td>
</tr></table></div></figure></notextile></div>]]&gt;</content></entry></feed>